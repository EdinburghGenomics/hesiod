#!/bin/bash

# Bootstrap a new VEnv in ./_hesiod_venv suitable for running Hesiod.
# The idea is that we make a new VEnv for each version released and so
# we really can roll back to an old version and get the exact same
# behaviour.
# Note that unlike Illuminatus I'm going to install snakemake into
# the VEnv. I'll likely make the same change for Illuminatus soon, but
# see doc/snakemake_be_careful.txt.

if [[ "$0" == "$BASH_SOURCE" ]] ; then
    echo "You need to source this file, not run it."
    exit 1
fi

activate_venv() {
    #We need to ensure -u is not set but then put the old value back.
    reset=`set +o | grep -w nounset` ; set +o nounset
    source ./_hesiod_venv/bin/activate
    eval $reset
}

if [ -e ./_hesiod_venv/bin/activate ] ; then

    # We already got one!
    activate_venv

else
    echo "Bootstrapping new VEnv from toolbox/bootstrap_python3"
    ( set -e ;
        # Best to resolve the symlink before bootstrapping the VEnv
        _py3="${TOOLBOX:-`dirname $BASH_SOURCE`/toolbox}"/bootstrap_python3
        "$(readlink -f "$_py3")" -mvenv ./_hesiod_venv
        activate_venv

        pip3 install pip==19.2.1
        pip3 install pyyaml==5.1.1
        pip3 install yamlloader==0.5.5
        pip3 install Rt==1.0.11
        pip3 install pystache==0.5.4

        # things needed for Blobtools - we are using
        # https://github.com/EdinburghGenomics/blobtools/tree/tims_patches
        pip install docopt==0.6.2
        pip install matplotlib==3.0.3
        pip install pysam==0.15.2
        pip install tqdm==4.32.2

        # snakemake and drmaa
        pip install snakemake==5.5.3
        pip install drmaa==0.7.9

        # For access the Clarity
        pip3 install pyclarity_lims==0.4.8
        pip3 install psycopg2-binary==2.8.3

        # Hereâ€™s the big one
        pip install NanoPlot==1.26.1
    )
    if [ $? = 0 ] ; then
        # We need this since we quit the subshell
        activate_venv
    else
        echo "Provisioning VEnv Failed!"
        false
    fi
fi
